# AEM HTL Best Practices

## ğŸš¨ MANDATORY: Rule File Behavior - NO EXCEPTIONS (AI Reference Only)

**âš ï¸ CRITICAL: ALWAYS read this rule file first before creating any HTL templates:**
1. **ğŸš¨ MANDATORY: ALWAYS read the rule file first** - **NO EXCEPTIONS**
2. **ğŸš¨ MANDATORY: Follow all HTL rules exactly** - **NO MODIFICATIONS**
3. **ğŸš¨ MANDATORY: Apply best practices as specified** - **NO SKIPPING**
4. **ğŸš¨ MANDATORY: Avoid forbidden patterns** - **NO IGNORING**

## ğŸš¨ ANTI-MISBEHAVIOR RULES
**âš ï¸ CRITICAL: NEVER do these things:**
1. **NEVER ask for information not specified in this rule file**
2. **NEVER assume what the user wants**
3. **NEVER skip reading rule files**
4. **NEVER deviate from the exact process specified**
5. **NEVER add your own interpretation of what should happen next**
6. **NEVER ask for HTL configuration details before following the exact process in this file**
7. **NEVER bypass the user interface flow specified in this file**

## **ğŸš¨ MANDATORY: HTL Logic Rules - NO EXCEPTIONS**

**âš ï¸ CRITICAL: These rules MUST be followed without fail. Violation will cause compilation errors and component failures.**

### **ğŸš« FORBIDDEN: Index Logic Patterns - NEVER USE:**
```html
<!-- âŒ FORBIDDEN - Causes compilation errors -->
<div data-sly-test="${categoryList.index < 2}">
<div data-sly-test="${categoryList.index >= 2}">

<!-- âŒ FORBIDDEN - Comparison operators not supported -->
<div data-sly-test="${categoryList.index > 1}">
<div data-sly-test="${categoryList.index <= 3}">

<!-- âŒ FORBIDDEN - Division operations not supported -->
<div data-sly-test="${categoryList.index <= categoryList.count / 2}">
<div data-sly-test="${categoryList.index > model.categories.size / 2}">
```

### **âœ… MANDATORY: Index Logic Patterns - ALWAYS USE:**
```html
<!-- âœ… MANDATORY - Specific index checks -->
<div data-sly-test="${categoryList.first}">           <!-- Index 0 -->
<div data-sly-test="${categoryList.index == 1}">      <!-- Index 1 -->
<div data-sly-test="${categoryList.index == 2}">      <!-- Index 2 -->
<div data-sly-test="${categoryList.index == 3}">      <!-- Index 3 -->
<div data-sly-test="${categoryList.last}">            <!-- Last index -->

<!-- âœ… MANDATORY - Multiple index conditions -->
<div data-sly-test="${categoryList.first || categoryList.index == 1}">
<div data-sly-test="${categoryList.index == 2 || categoryList.index == 3}">
```

### **Layout Distribution Patterns:**

#### **ğŸš¨ MANDATORY: 2-Column Layout (Left/Right) - REQUIRED APPROACH:**
```html
<!-- ğŸš¨ MANDATORY: Use Sling Model methods for dynamic distribution -->
<!-- Left Column -->
<div class="left-column" data-sly-test="${model.leftItems}">
    <div data-sly-repeat.item="${model.leftItems}">
        <div class="item-content">
            <!-- Item content -->
        </div>
    </div>
</div>

<!-- Right Column -->
<div class="right-column" data-sly-test="${model.rightItems}">
    <div data-sly-repeat.item="${model.rightItems}">
        <div class="item-content">
            <!-- Item content -->
        </div>
    </div>
</div>
```

#### **ğŸš« FORBIDDEN: 2-Column Layout (Left/Right) - NEVER USE FOR DYNAMIC CONTENT:**
```html
<!-- ğŸš« FORBIDDEN: Only use for fixed 4-item layouts - causes empty boxes -->
<!-- Left Column -->
<div class="left-column">
    <div data-sly-repeat.item="${model.items}">
        <div data-sly-test="${itemList.first || itemList.index == 1}">
            <!-- First 2 items -->
        </div>
    </div>
</div>

<!-- Right Column -->
<div class="right-column">
    <div data-sly-repeat.item="${model.items}">
        <div data-sly-test="${itemList.index == 2 || itemList.index == 3}">
            <!-- Last 2 items -->
        </div>
    </div>
</div>
```

#### **3-Column Layout (Left/Center/Right):**
```html
<!-- Left Column -->
<div class="left-column">
    <div data-sly-repeat.item="${model.items}">
        <div data-sly-test="${itemList.first || itemList.index == 1}">
            <!-- First 2 items -->
        </div>
    </div>
</div>

<!-- Center Column -->
<div class="center-column">
    <!-- Central content -->
</div>

<!-- Right Column -->
<div class="right-column">
    <div data-sly-repeat.item="${model.items}">
        <div data-sly-test="${itemList.index == 2 || itemList.index == 3}">
            <!-- Last 2 items -->
        </div>
    </div>
</div>
```

### **ğŸš¨ MANDATORY: ClientLibs Inclusion - REQUIRED:**
```html
<!-- ğŸš¨ MANDATORY: ALWAYS include ClientLibs at the top -->
<sly data-sly-use.clientlib="/libs/granite/sightly/templates/clientlib.html" 
     data-sly-call="${clientlib.css @ categories='project.components.component-name'}"></sly>

<div class="component-name" data-sly-use.model="com.project.aem.core.models.ComponentModel">
    <!-- Component content -->
</div>
```

### **ğŸš¨ MANDATORY: Layout Structure Planning - REQUIRED:**

#### **ğŸš¨ MANDATORY: Layout Analysis Before HTL Creation:**
1. **ğŸš¨ MANDATORY: Identify layout pattern** - Single column, two column, grid, etc.
2. **ğŸš¨ MANDATORY: Plan container structure** - Main container, sections, subsections
3. **ğŸš¨ MANDATORY: Map section positioning** - Left, right, top, bottom sections
4. **ğŸš¨ MANDATORY: Plan CSS layout strategy** - Grid, flexbox, positioning method

#### **ğŸš¨ MANDATORY: Two-Column Layout Pattern:**
```html
<!-- ğŸš¨ MANDATORY: Two-column layout structure -->
<div class="component-name" data-sly-use.model="com.project.aem.core.models.ComponentModel">
    <div class="component-name__container">
        <!-- Left Section -->
        <div class="component-name__left-section">
            <!-- Left column content -->
        </div>
        
        <!-- Right Section -->
        <div class="component-name__right-section">
            <!-- Right column content -->
        </div>
    </div>
</div>
```

#### **ğŸš¨ MANDATORY: Single Column Layout Pattern:**
```html
<!-- ğŸš¨ MANDATORY: Single column layout structure -->
<div class="component-name" data-sly-use.model="com.project.aem.core.models.ComponentModel">
    <div class="component-name__container">
        <!-- Header Section -->
        <div class="component-name__header">
            <!-- Header content -->
        </div>
        
        <!-- Main Section -->
        <div class="component-name__main">
            <!-- Main content -->
        </div>
        
        <!-- Footer Section -->
        <div class="component-name__footer">
            <!-- Footer content -->
        </div>
    </div>
</div>
```

### **ğŸš¨ MANDATORY: Semantic HTML Structure - REQUIRED:**
```html
<!-- ğŸš¨ MANDATORY: Use semantic HTML elements -->
<section class="component-name" data-sly-use.model="com.project.aem.core.models.ComponentModel">
    <header class="component-name__header">
        <!-- Header content -->
    </header>
    
    <main class="component-name__main">
        <!-- Main content -->
    </main>
    
    <footer class="component-name__footer">
        <!-- Footer content -->
    </footer>
</section>
```

### **ğŸš¨ MANDATORY: Data Validation - REQUIRED:**
```html
<!-- ğŸš¨ MANDATORY: Always validate data before display -->
<div data-sly-test="${model.title}">
    <h2>${model.title}</h2>
</div>

<div data-sly-test="${model.items && model.items.size > 0}">
    <div data-sly-repeat.item="${model.items}">
        <!-- Item content -->
    </div>
</div>
```

### **ğŸš¨ MANDATORY: HTL Context Rules - REQUIRED:**

#### **ğŸš« FORBIDDEN: Missing Context in Style Attributes:**
```html
<!-- âŒ FORBIDDEN - Causes compilation errors -->
<div style="background-image: url('${model.image}');">
<div style="opacity: ${model.opacity};">
```

#### **âœ… MANDATORY: Proper Context for Style Attributes:**
```html
<!-- âœ… MANDATORY - Use @ context='styleString' for CSS values -->
<div style="background-image: url('${model.image @ context='styleString'}');">
<div style="opacity: ${model.opacity @ context='styleString'};">
```

#### **ğŸš« FORBIDDEN: Invalid HTL Attributes:**
```html
<!-- âŒ FORBIDDEN - data-sly-unescaped is not a valid HTL attribute -->
<div data-sly-unescaped="${content @ context='html'}">
```

#### **âœ… MANDATORY: Proper HTML Content Rendering:**
```html
<!-- âœ… MANDATORY - Use direct expression with @ context='html' -->
<div>${content @ context='html'}</div>
```

#### **ğŸš« FORBIDDEN: Arithmetic Operations in HTL:**
```html
<!-- âŒ FORBIDDEN - Arithmetic operations cause compilation errors -->
<div data-sly-test="${itemList.index + 1}">
<div style="opacity: ${model.opacity / 100};">
```

#### **âœ… MANDATORY: Move Arithmetic to Sling Models:**
```java
// âœ… MANDATORY - Handle arithmetic in Sling Model
public String getDisplayIndex() {
    return String.valueOf(index + 1);
}

public String getOpacityValue() {
    return String.valueOf(opacity / 100.0);
}
```

```html
<!-- âœ… MANDATORY - Use pre-calculated values in HTL -->
<div data-sly-test="${itemList.displayIndex}">
<div style="opacity: ${model.opacityValue @ context='styleString'};">
```

### **ğŸš¨ MANDATORY: Dynamic Content Distribution - Sling Model Pattern:**

#### **ğŸš¨ REQUIRED: For Dynamic Item Distribution (6, 7, 8+ items):**
```java
// ğŸš¨ MANDATORY: Handle distribution logic in Sling Model
public List<ItemModel> getLeftItems() {
    int halfSize = items.size() / 2;
    return items.subList(0, halfSize);
}

public List<ItemModel> getRightItems() {
    int halfSize = items.size() / 2;
    return items.subList(halfSize, items.size());
}
```

#### **Distribution Examples:**
- **6 items**: Left 3, Right 3
- **7 items**: Left 3, Right 4 (right gets extra)
- **8 items**: Left 4, Right 4
- **9 items**: Left 4, Right 5 (right gets extra)

#### **Benefits of Sling Model Approach:**
1. **No HTL compilation errors** - Avoids division/comparison operators
2. **Dynamic distribution** - Works with any number of items
3. **Cleaner templates** - No complex index logic in HTL
4. **Better maintainability** - Logic centralized in Java
5. **No empty boxes** - Only renders items that exist

### **ğŸš« FORBIDDEN: HTL Mistakes - NEVER ALLOWED:**

1. **ğŸš« FORBIDDEN: Using comparison operators** (`<`, `>`, `<=`, `>=`) - **CAUSES COMPILATION ERRORS**
2. **ğŸš« FORBIDDEN: Missing ClientLibs inclusion** - **CAUSES STYLING FAILURES**
3. **ğŸš« FORBIDDEN: Not validating data before display** - **CAUSES RUNTIME ERRORS**
4. **ğŸš« FORBIDDEN: Using non-semantic HTML elements** - **CAUSES ACCESSIBILITY ISSUES**
5. **ğŸš« FORBIDDEN: Complex nested conditions** - **CAUSES MAINTENANCE ISSUES**
6. **ğŸš« FORBIDDEN: Missing data-sly-test conditions** - **CAUSES EMPTY BOXES**
7. **ğŸš« FORBIDDEN: Creating empty divs with borders** - **CAUSES VISUAL BUGS**
8. **ğŸš« FORBIDDEN: Hard-coding item counts** - **CAUSES SCALABILITY ISSUES**
9. **ğŸš« FORBIDDEN: Using division operations in HTL** - **CAUSES COMPILATION ERRORS**
10. **ğŸš« FORBIDDEN: Not using Sling Model for complex logic** - **CAUSES TEMPLATE COMPLEXITY**
11. **ğŸš« FORBIDDEN: Using `data-sly-unescaped` attribute** - **NOT A VALID HTL ATTRIBUTE**
12. **ğŸš« FORBIDDEN: Missing `@ context` for expressions in style attributes** - **CAUSES COMPILATION ERRORS**
13. **ğŸš« FORBIDDEN: Arithmetic operations in HTL expressions** - **CAUSES COMPILATION ERRORS**

### **ğŸš¨ MANDATORY: HTL Testing Checklist - ALL MUST PASS:**

#### **ğŸš¨ MANDATORY: Layout Structure Validation:**
- [ ] **ğŸš¨ MANDATORY: Layout pattern correctly implemented** - **DESIGN MISMATCH IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Section positioning matches design** - **VISUAL BUGS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Container structure properly planned** - **LAYOUT FAILS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: CSS layout strategy correctly applied** - **STYLING FAILS IF NOT MET**

#### **ğŸš¨ MANDATORY: Visual Style Validation:**
- [ ] **ğŸš¨ MANDATORY: Color scheme correctly implemented** - **DESIGN MISMATCH IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Typography matches design specifications** - **VISUAL BUGS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Spacing and sizing correct** - **LAYOUT ISSUES IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Visual effects properly applied** - **STYLING FAILS IF NOT MET**

#### **ğŸš¨ MANDATORY: Interactive Element Validation:**
- [ ] **ğŸš¨ MANDATORY: All clickable elements properly positioned** - **FUNCTIONALITY FAILS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Interactive element styling correct** - **VISUAL BUGS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Hover effects and transitions work** - **USER EXPERIENCE FAILS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Navigation controls properly implemented** - **FUNCTIONALITY FAILS IF NOT MET**

#### **ğŸš¨ MANDATORY: Technical Implementation Validation:**
- [ ] **ğŸš¨ MANDATORY: No compilation errors** - **BUILD WILL FAIL IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: All data properly validated** - **RUNTIME ERRORS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: ClientLibs included** - **STYLING WILL FAIL IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Semantic HTML structure** - **ACCESSIBILITY FAILS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Proper index logic (no comparisons)** - **COMPILATION FAILS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Responsive layout works** - **MOBILE BREAKS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: All content displays correctly** - **VISUAL BUGS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: No empty boxes/divs rendered** - **VISUAL BUGS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Dynamic distribution works (test with 6, 7, 8+ items)** - **SCALABILITY FAILS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Sling Model methods used for complex logic** - **MAINTENANCE FAILS IF NOT MET**
- [ ] **ğŸš¨ MANDATORY: Template logic is clean and maintainable** - **DEVELOPMENT FAILS IF NOT MET**

**âš ï¸ CRITICAL: ALL checklist items MUST pass before component is considered complete.**

### **ğŸš¨ MANDATORY: CSS Sizing Rules - NO EXCEPTIONS**

**âš ï¸ CRITICAL: These CSS rules MUST be followed to prevent component sizing issues in AEM authoring mode:**

#### **ğŸš« FORBIDDEN: Viewport-Based Sizing - NEVER USE:**
```scss
/* âŒ FORBIDDEN - Causes component size increase in authoring mode */
.component {
  min-height: 100vh;    // NEVER use viewport height
  height: 100vh;        // NEVER use viewport height
  min-height: 100%;     // NEVER use percentage height
  height: 100%;         // NEVER use percentage height
}
```

#### **âœ… MANDATORY: Safe Sizing Patterns - ALWAYS USE:**
```scss
/* âœ… MANDATORY - Use content-based sizing */
.component {
  min-height: auto;     // Let content determine height
  height: auto;         // Let content determine height
  padding: 40px 20px;   // Use reasonable padding values
  margin: 20px 0;       // Use reasonable margin values
}

/* âœ… MANDATORY - Use max-width for responsive design */
.component {
  max-width: 1200px;    // Constrain maximum width
  margin: 0 auto;       // Center the component
}
```

#### **ğŸš¨ MANDATORY: Padding and Margin Guidelines:**
```scss
/* âœ… MANDATORY - Reasonable padding values */
.component__header {
  padding: 40px 20px 30px;  // Top, Left/Right, Bottom
}

.component__content {
  padding: 30px 20px;       // Vertical, Horizontal
}

/* âŒ FORBIDDEN - Excessive padding values */
.component__header {
  padding: 80px 40px 60px;  // Too large for authoring mode
}
```

**Why These Rules Matter:**
- âœ… **Prevents component size increase** in AEM authoring mode
- âœ… **Makes editing manageable** with reasonable component dimensions
- âœ… **Ensures responsive design** without viewport dependencies
- âœ… **Improves authoring experience** with properly sized components
